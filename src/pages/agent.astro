---
import { actions } from "astro:actions";
import { db, eq, Sessions } from "astro:db";
import AgentClient from "@/components/AgentClient";
import SessionHistory from "@/components/SessionHistory";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getUsernameFromCookie } from "@/lib/auth";

const logoutResult = Astro.getActionResult(actions.logout);
if (logoutResult && !logoutResult.error) {
  return Astro.redirect("/");
}

const username = await getUsernameFromCookie(Astro.cookies);
if (!username) {
  return Astro.redirect("/?error=not_logged_in");
}

// Get the user's existing session to enable session resumption
const [userSession] = await db
  .select()
  .from(Sessions)
  .where(eq(Sessions.userId, username))
  .limit(1);

const initialSessionId = userSession?.id || null;
---

<BaseLayout title="ADK Agent Demo" bodyClass="min-h-screen">
  <main class="max-w-4xl mx-auto p-8 space-y-4">
    <form action={actions.logout} method="POST" class="flex justify-end">
      <button
        type="submit"
        class="text-sm opacity-80 hover:text-destructive underline"
      >
        Logout
      </button>
    </form>
    <h1 class="text-2xl font-semibold">Countries Agent</h1>
    <AgentClient
      username={username}
      initialSessionId={initialSessionId}
      client:load
    />
    <SessionHistory sessionId={initialSessionId} client:load />
  </main>
</BaseLayout>
