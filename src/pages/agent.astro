---
import { db, Sessions, eq } from 'astro:db';
import { getUsernameFromCookie } from '@/lib/auth';
import AgentClient from '@/components/AgentClient';
import '@/styles/global.css';

const username = await getUsernameFromCookie(Astro.cookies);

// If not logged in, redirect to home
if (!username) {
	return Astro.redirect("/?error=not_logged_in");
}

// Get the user's existing session to enable session resumption
const [userSession] = await db
	.select()
	.from(Sessions)
	.where(eq(Sessions.userId, username))
	.limit(1);

const initialSessionId = userSession?.id || null;
---

<html lang="en">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>ADK Agent Demo</title>
	</head>
	<body class="bg-gray-50 min-h-screen text-gray-900 font-sans">
		<main class="max-w-4xl mx-auto p-4 md:p-8">
			<AgentClient username={username} initialSessionId={initialSessionId} client:load />
		</main>
	</body>
</html>
