---
import BaseLayout from '@/layouts/BaseLayout.astro';
import { getUsernameFromCookie } from '@/lib/auth';
import { actions } from 'astro:actions';

// Handle action results and redirects
const loginResult = Astro.getActionResult(actions.login);
const logoutResult = Astro.getActionResult(actions.logout);

if (loginResult && !loginResult.error) {
	return Astro.redirect("/agent");
}

if (logoutResult && !logoutResult.error) {
	return Astro.redirect("/");
}

const username = await getUsernameFromCookie(Astro.cookies);
const error = Astro.url.searchParams.get('error');

let errorMessage = '';
if (error === 'not_logged_in') errorMessage = 'Please log in first.';
if (loginResult?.error) {
	if (loginResult.error.message === 'username_required') {
		errorMessage = 'Username is required.';
	} else if (loginResult.error.message === 'user_not_found') {
		errorMessage = 'User not found. Please check your username.';
	} else {
		errorMessage = 'An unknown error occurred.';
	}
} else {
	if (error === 'username_required') errorMessage = 'Username is required.';
	if (error === 'user_not_found') errorMessage = 'User not found. Please check your username.';
	if (error === 'unknown') errorMessage = 'An unknown error occurred.';
}

---

<BaseLayout title="ADK Demo Login" bodyClass="min-h-screen flex items-center justify-center py-32">
	<div class="max-w-md w-full space-y-4">
		<h1 class="text-3xl font-semibold text-center">Countries Agent Demo</h1>
			
		{username ? (
			<div class="flex flex-col gap-4">
				<p>Logged in as <strong>{username}</strong></p>
				<a
					href="/agent"
					class="bg-primary text-primary-foreground py-2 px-6 rounded text-center"
				>
					Go to Agent
				</a>
				<form action={actions.logout} method="POST">
					<button
						type="submit"
						class="w-full bg-destructive text-primary-foreground py-2 px-6 rounded"
					>
						Logout
					</button>
				</form>
			</div>
		) : (
			<form action={actions.login} method="POST" class="flex flex-col gap-4">
				<div class="flex flex-col gap-2">
					<label for="username">Username</label>
					<input
						type="text"
						name="username"
						id="username"
						placeholder="testuser"
						class="border border-current/25 p-2 rounded accent-primary bg-muted"
						required
					/>
				</div>

				{errorMessage && (
					<div class="p-4 bg-destructive/10 text-destructive rounded">
						{errorMessage}
					</div>
				)}

				<button
					type="submit"
					class="bg-primary text-primary-foreground py-2 px-6 rounded"
				>
					Login
				</button>
			</form>
		)}
	</div>
</BaseLayout>
